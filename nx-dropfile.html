<dom-module id="nx-dropfile">
    <style>
        .dropzone{
            background-color:#CCC;
        }
    </style>
    <template>
        <input id="dropSelect" type="file" id="input" multiple>
        <div id="dropzone" class="dropzone" >
            dropfile
            <template is="dom-repeat" items="{{files}}">
                <div on-tap="downloadFile" key="{{item.key}}">
                    {{item.name}} // {{item.percent}}
                </div>
              
           </template>
        </div>
        <button on-tap="upload">upload</button>
    </template>
    <script>

        Polymer({
            is:'nx-dropfile',
            properties:{
                files:{
                    type:Object,
                    value:function(){
                        return [];
                    },
                    notify:true
                }
            },
            ready:function(){
                this.testza = this;
                var dropzone = this.$.dropzone;
                dropzone.ondragover = dropzone.ondragenter = function(event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                var rootDom = this;
                var pushFiles = (files)=>{
                    for (var i = 0; i < files.length; i++) {
                        rootDom.push('files',files[i]);
                    }
                }

                dropzone.ondrop = function(event){
                    event.stopPropagation();
                    event.preventDefault();
                    
                    var files = event.dataTransfer.files;
                    pushFiles(files);
                    rootDom.upload();
                }

                this.$.dropSelect.onchange = function(){
                    var files = this.files;
                    pushFiles(files);
                    rootDom.upload();
                }
                
            },
            upload:function(){

                this.files.map((fileItem,i)=>{
                    if(typeof fileItem.status == "undefined"){
                        this.set(`files.${i}.status`,'uploading');

                        var data = new FormData();
                        data.append('file',fileItem);

                        var config = {
                            onUploadProgress: (progressEvent)=>{
                                var percentCompleted = progressEvent.loaded / progressEvent.total;
                                this.set(`files.${i}.percent`,percentCompleted);
                                if(percentCompleted==1){
                                    this.set(`files.${i}.status`,'complete');
                                }
                            }
                        };

                        axios.put('http://localhost:3000/api/eu/test/upload', data,config)
                        .then( (res)=>{
                            this.set(`files.${i}.key`,res.data.generated_keys[0]);
                            console.log(this.files);
                        })
                        .catch( (err)=>{
                            console.log(err.message);
                        });
                    }


                });
            },
            downloadFile:function(e){
                if(e.currentTarget.key){
                    console.log(e.currentTarget.key);
                    window.open("http://localhost:3000/api/eu/test/download/"+e.currentTarget.key, '_blank');
                }
            }
        });

    </script>

</dom-module>